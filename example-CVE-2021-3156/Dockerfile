FROM --platform=linux/amd64 aflplusplus/aflplusplus:latest

#download sudo
RUN wget -c https://www.sudo.ws/dist/sudo-1.9.5p1.tar.gz
RUN tar xzf sudo-1.9.5p1.tar.gz

#argv-fuzzing
RUN cd ~/sudo-1.9.5p1
RUN cp ~/AFLplusplus/utils/argv_fuzzing/argv-fuzz-inl.h src/

#patch sudo to enable argv-fuzzing
RUN sed -i'.original' -e '68 s/^/#include "argv-fuzz-inl.h"\n/' src/sudo.c
RUN sed -i'.original' -e '151 s/^/AFL_INIT_ARGV();\n/' src/sudo.c

#disable password prompt
RUN sed -i'.original' -e '260 s/^/return 0;\n/' plugins/sudoers/auth/sudo_auth.c

#build sudo
RUN CFLAGS="-g" LDFLAGS="-g" CC=afl-clang-fast ./configure --prefix=/fuzz/sudo
RUN make
RUN sudo make install

#test sudo
RUN echo -ne "sudo\0id\0\0" | /fuzz/sudo/bin/sudo
#expected
#uid=0(root) gid=0(root) groups=0(root)

