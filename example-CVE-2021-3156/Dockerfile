FROM --platform=linux/amd64 aflplusplus/aflplusplus:latest

#download sudo
WORKDIR /
RUN wget -c https://www.sudo.ws/dist/sudo-1.9.5p1.tar.gz
RUN tar xzf sudo-1.9.5p1.tar.gz

#argv-fuzzing
RUN cp /AFLplusplus/utils/argv_fuzzing/argv-fuzz-inl.h /sudo-1.9.5p1/src/

#patch sudo to enable argv-fuzzing

RUN sed -i'.original' -e '68 s/^/#include "argv-fuzz-inl.h"\n/' /sudo-1.9.5p1/src/sudo.c
RUN sed -i'.original' -e '153 s/^/    AFL_INIT_ARGV();\n/' /sudo-1.9.5p1/src/sudo.c
RUN sed -i'.original' -e '85 s/^/if 0\n/' /sudo-1.9.5p1/lib/util/progname.c


#disable password prompt
RUN sed -i'.original' -e '263 s/^/    return 0;\n/' /sudo-1.9.5p1/plugins/sudoers/auth/sudo_auth.c

#build sudo
WORKDIR /sudo-1.9.5p1
RUN CFLAGS="-g" LDFLAGS="-g" CC=afl-clang-fast ./configure --prefix=/fuzz/sudo
RUN make -j8
RUN make -j8 install

#test sudo
ENV AFL_IGNORE_PROBLEMS=1
RUN 'echo -ne "sudo\0id\0\0" | /fuzz/sudo/bin/sudo'
#expected
#uid=0(root) gid=0(root) groups=0(root)

#create input/output directories
RUN mkdir /fuzz/sudo/input
RUN mkdir /fuzz/sudo/output
RUN 'echo -ne "sudo\0id\0\0" > /fuzz/sudo/input/payload1'
RUN 'echo -ne "sudoedit\0-s\0a\0" > /fuzz/sudo/input/payload2'

#install screen
RUN apt-get update
RUN apt-get install -y screen

WORKDIR /
ENTRYPOINT [ "/bin/bash" ]
